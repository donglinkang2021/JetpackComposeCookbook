<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>协程加载文件 - My Docs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Jetpack Compose Code Snippet</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Compose <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">基本控件</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../Compose/%E5%9F%BA%E6%9C%AC%E6%8E%A7%E4%BB%B6/Card/" class="dropdown-item">Card</a>
</li>
            
<li>
    <a href="../../Compose/%E5%9F%BA%E6%9C%AC%E6%8E%A7%E4%BB%B6/Column/" class="dropdown-item">Column</a>
</li>
            
<li>
    <a href="../../Compose/%E5%9F%BA%E6%9C%AC%E6%8E%A7%E4%BB%B6/Image/" class="dropdown-item">Image</a>
</li>
            
<li>
    <a href="../../Compose/%E5%9F%BA%E6%9C%AC%E6%8E%A7%E4%BB%B6/LazyColumn/" class="dropdown-item">LazyColumn</a>
</li>
            
<li>
    <a href="../../Compose/%E5%9F%BA%E6%9C%AC%E6%8E%A7%E4%BB%B6/Spacer/" class="dropdown-item">Spacer</a>
</li>
            
<li>
    <a href="../../Compose/%E5%9F%BA%E6%9C%AC%E6%8E%A7%E4%BB%B6/Surface/" class="dropdown-item">Surface</a>
</li>
            
<li>
    <a href="../../Compose/%E5%9F%BA%E6%9C%AC%E6%8E%A7%E4%BB%B6/Text/" class="dropdown-item">Text</a>
</li>
            
<li>
    <a href="../../Compose/%E5%9F%BA%E6%9C%AC%E6%8E%A7%E4%BB%B6/TextField/" class="dropdown-item">TextField</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">完整demo</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../Compose/%E5%AE%8C%E6%95%B4demo/%E5%8D%8F%E7%A8%8B%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6/" class="dropdown-item">协程读取文件</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">实用控件</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../Compose/%E5%AE%9E%E7%94%A8%E6%8E%A7%E4%BB%B6/Align/" class="dropdown-item">Alignment</a>
</li>
            
<li>
    <a href="../../Compose/%E5%AE%9E%E7%94%A8%E6%8E%A7%E4%BB%B6/AlignRow/" class="dropdown-item">AlignRow</a>
</li>
            
<li>
    <a href="../../Compose/%E5%AE%9E%E7%94%A8%E6%8E%A7%E4%BB%B6/CollectionGrid/" class="dropdown-item">CollectionGrid</a>
</li>
            
<li>
    <a href="../../Compose/%E5%AE%9E%E7%94%A8%E6%8E%A7%E4%BB%B6/FavouriteCollectionCard/" class="dropdown-item">Favorite Collection Card</a>
</li>
            
<li>
    <a href="../../Compose/%E5%AE%9E%E7%94%A8%E6%8E%A7%E4%BB%B6/Scaffold/" class="dropdown-item">Scaffold</a>
</li>
            
<li>
    <a href="../../Compose/%E5%AE%9E%E7%94%A8%E6%8E%A7%E4%BB%B6/SearchBar/" class="dropdown-item">SearchBar</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">实用控件2</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../Compose/%E5%AE%9E%E7%94%A8%E6%8E%A7%E4%BB%B62/" class="dropdown-item">README</a>
</li>
            
<li>
    <a href="../../Compose/%E5%AE%9E%E7%94%A8%E6%8E%A7%E4%BB%B62/AlertButton/" class="dropdown-item">AlertButton</a>
</li>
            
<li>
    <a href="../../Compose/%E5%AE%9E%E7%94%A8%E6%8E%A7%E4%BB%B62/CheckItem/" class="dropdown-item">CheckItem</a>
</li>
            
<li>
    <a href="../../Compose/%E5%AE%9E%E7%94%A8%E6%8E%A7%E4%BB%B62/PredictionList/" class="dropdown-item">PredictionList</a>
</li>
            
<li>
    <a href="../../Compose/%E5%AE%9E%E7%94%A8%E6%8E%A7%E4%BB%B62/PreferScreen/" class="dropdown-item">PreferScreen</a>
</li>
            
<li>
    <a href="../../Compose/%E5%AE%9E%E7%94%A8%E6%8E%A7%E4%BB%B62/SearchBar/" class="dropdown-item">SearchBar</a>
</li>
            
<li>
    <a href="../../Compose/%E5%AE%9E%E7%94%A8%E6%8E%A7%E4%BB%B62/TopBar/" class="dropdown-item">TopBar</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">注意</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../Compose/%E6%B3%A8%E6%84%8F/Activity/" class="dropdown-item">Activity</a>
</li>
            
<li>
    <a href="../../Compose/%E6%B3%A8%E6%84%8F/%E8%BF%9E%E6%8E%A5%E7%BD%91%E7%BB%9C/" class="dropdown-item">连接网络</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">编程技术</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../Compose/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/Animation/" class="dropdown-item">Animation</a>
</li>
            
<li>
    <a href="../../Compose/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DataStore/" class="dropdown-item">datastore</a>
</li>
            
<li>
    <a href="../../Compose/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/Hilt/" class="dropdown-item">Hilt</a>
</li>
            
<li>
    <a href="../../Compose/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/Modifier/" class="dropdown-item">Modifier</a>
</li>
            
<li>
    <a href="../../Compose/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/Preview/" class="dropdown-item">Preview</a>
</li>
            
<li>
    <a href="../../Compose/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/ViewModel/" class="dropdown-item">ViewModel</a>
</li>
            
<li>
    <a href="../../Compose/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/by/" class="dropdown-item">by</a>
</li>
            
<li>
    <a href="../../Compose/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/remember/" class="dropdown-item">remember</a>
</li>
            
<li>
    <a href="../../Compose/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/%E5%BF%AB%E6%8D%B7%E9%94%AE/" class="dropdown-item">快捷键</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">DailyNote <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../DailyNote/%E5%BC%80%E5%8F%91%E7%BB%8F%E5%8E%86/" class="dropdown-item">开发经历</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">askGPT <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active">协程加载文件</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../../DailyNote/%E5%BC%80%E5%8F%91%E7%BB%8F%E5%8E%86/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="2"><a href="#ask" class="nav-link">ASK</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#gptdemo" class="nav-link">GPT(顺利解决，代码在完整demo中)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h2 id="ask">ASK</h2>
<p>我的这个下面的协程加载读取文件的jetpack compose不能应用，你能帮我看看为什么吗</p>
<pre><code class="language-kotlin">package com.linkdom.readbook

import android.annotation.SuppressLint
import android.content.Context
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.material.Button
import androidx.compose.material.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.MutableState
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.tooling.preview.Preview
import kotlinx.coroutines.*
import java.io.BufferedReader
import java.io.File
import java.io.InputStreamReader


@OptIn(DelicateCoroutinesApi::class)
@Composable
fun Test() {
    val context = LocalContext.current
    val text = remember { mutableStateOf(&quot;&quot;) }
    Column (
        modifier = Modifier.fillMaxSize(),
        horizontalAlignment = Alignment.CenterHorizontally
            ){
        Button(onClick = {
            GlobalScope.launch(Dispatchers.Main) {
                readFile(context){
                    text.value = it
                }
            }
        }) {
            Text(&quot;读取文件&quot;)
        }
        Text(text = text.value)
    }
}

@SuppressLint(&quot;CoroutineCreationDuringComposition&quot;)
@OptIn(DelicateCoroutinesApi::class)
private fun readFile(
    context: Context,
    onRead: (String) -&gt; Unit
) {
    GlobalScope.launch(Dispatchers.IO) {
//        println(&quot;${Thread.currentThread().name}执行文件读取任务。\n&quot;)
        val inputStream = File(&quot;app/src/main/res/tmp.txt&quot;).inputStream()
        val bufferedReader = BufferedReader(InputStreamReader(inputStream))
        var line: String? = bufferedReader.readLine()
        while (line != null) {
            onRead(line)
            line = bufferedReader.readLine()
        }
    }
}

@Preview(showBackground = true)
@Composable
fun Test4() {
    Test()
}
</code></pre>
<p>报错如下：</p>
<pre><code>E/AndroidRuntime: FATAL EXCEPTION: DefaultDispatcher-worker-1
    Process: com.linkdom.readbook, PID: 31890
    java.io.FileNotFoundException: app/src/main/res/tmp.txt: open failed: ENOENT (No such file or directory)
        at libcore.io.IoBridge.open(IoBridge.java:496)
        at java.io.FileInputStream.&lt;init&gt;(FileInputStream.java:159)
        at com.linkdom.readbook.TestReadRes4Kt$readFile$1.invokeSuspend(TestReadRes4.kt:53)
        at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:33)
        at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:106)
        at kotlinx.coroutines.internal.LimitedDispatcher.run(LimitedDispatcher.kt:42)
        at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:95)
        at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:570)
        at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:750)
        at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:677)
        at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:664)
        Suppressed: kotlinx.coroutines.DiagnosticCoroutineContextException: [StandaloneCoroutine{Cancelling}@555505, Dispatchers.IO]
    Caused by: android.system.ErrnoException: open failed: ENOENT (No such file or directory)
        at libcore.io.Linux.open(Native Method)
        at libcore.io.ForwardingOs.open(ForwardingOs.java:167)
        at libcore.io.BlockGuardOs.open(BlockGuardOs.java:252)
        at libcore.io.ForwardingOs.open(ForwardingOs.java:167)
        at android.app.ActivityThread$AndroidOs.open(ActivityThread.java:7255)
        at libcore.io.IoBridge.open(IoBridge.java:482)
            ... 10 more
I/Process: Sending signal. PID: 31890 SIG: 9

</code></pre>
<p>请用中文回答我。</p>
<h2 id="gptdemo">GPT(顺利解决，代码在完整demo中)</h2>
<p>从您提供的错误日志来看，问题出在找不到文件<code>app/src/main/res/tmp.txt</code>，具体错误为<code>java.io.FileNotFoundException</code>。</p>
<p>在Android应用中，您不能直接使用项目文件结构中的路径。您需要将文件放在应用的<code>assets</code>文件夹中，并使用<code>AssetManager</code>来读取文件。请按照以下步骤修改您的代码：</p>
<ol>
<li>将<code>tmp.txt</code>文件移动到<code>app/src/main/assets</code>文件夹下（如果没有该文件夹，请创建一个）。</li>
<li>修改<code>readFile</code>函数如下：</li>
</ol>
<pre><code class="language-kotlin">private fun readFile(
    context: Context,
    onRead: (String) -&gt; Unit
) {
    GlobalScope.launch(Dispatchers.IO) {
        val assetManager = context.assets
        val inputStream = assetManager.open(&quot;tmp.txt&quot;)
        val bufferedReader = BufferedReader(InputStreamReader(inputStream))
        var line: String? = bufferedReader.readLine()
        while (line != null) {
            onRead(line)
            line = bufferedReader.readLine()
        }
    }
}
</code></pre>
<p>这样就可以正确读取<code>tmp.txt</code>文件了。</p>
<p>另外，虽然在这个示例中使用<code>GlobalScope</code>可能不会产生问题，但是并不推荐在实际项目中使用<code>GlobalScope</code>，因为它可能导致内存泄漏和其他问题。建议使用<code>rememberCoroutineScope</code>取代<code>GlobalScope</code>。这里是使用<code>rememberCoroutineScope</code>的修改示例：</p>
<pre><code class="language-kotlin">@Composable
fun Test() {
    val context = LocalContext.current
    val text = remember { mutableStateOf(&quot;&quot;) }
    val coroutineScope = rememberCoroutineScope()
    Column (
        modifier = Modifier.fillMaxSize(),
        horizontalAlignment = Alignment.CenterHorizontally
            ){
        Button(onClick = {
            coroutineScope.launch {
                readFile(context) {
                    text.value = it
                }
            }
        }) {
            Text(&quot;读取文件&quot;)
        }
        Text(text = text.value)
    }
}
</code></pre>
<p>这样您的代码应该可以正常工作了。如果您还有其他问题，请随时向我提问。</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
